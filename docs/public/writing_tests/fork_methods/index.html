<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
        
        <style>

    html body {
        font-family: '', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #2196F3;
        --border-width:  0 ;
    }

</style>


<link rel="stylesheet" href="http://localhost:1313/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=">





<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" crossorigin="anonymous">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
 






<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.148.0">
        


        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        <link rel="stylesheet" href="http://localhost:1313/css/callouts.css">
    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#"></a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2></h2>
        <h5></h5>
        

    </div>

    <div align="start" class="content"><h1 id="using-and-extending-fork-methods">Using and Extending Fork Methods</h1>
<p>This document describes the Fork class in the Ethereum execution spec tests framework, which provides a standardized way to define properties of Ethereum forks. Understanding how to use and extend these fork methods is essential for writing flexible tests that can automatically adapt to different forks.</p>
<h2 id="overview">Overview</h2>
<p>The <code>BaseFork</code> class is an abstract base class that defines the interface for all Ethereum forks. Each implemented fork (like Frontier, Homestead, etc.) extends this class and implements its abstract methods to provide fork-specific behavior.</p>
<p>The fork system allows:</p>
<ol>
<li>Defining fork-specific behaviors and parameters</li>
<li>Comparing forks chronologically (<code>Paris &lt; Shanghai</code>)</li>
<li>Supporting automatic fork transitions</li>
<li>Writing tests that automatically adapt to different forks</li>
</ol>
<h2 id="using-fork-methods-in-tests">Using Fork Methods in Tests</h2>
<p>Fork methods are powerful tools that allow your tests to adapt to different Ethereum forks automatically. Here are common patterns for using them:</p>
<h3 id="1-check-fork-support-for-features">1. Check Fork Support for Features</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_some_feature</span>(fork):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> fork<span style="color:#f92672">.</span>supports_blobs(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Test blob-related functionality</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Test alternative or skip</span>
</span></span><span style="display:flex;"><span>        pytest<span style="color:#f92672">.</span>skip(<span style="color:#e6db74">&#34;Fork does not support blobs&#34;</span>)
</span></span></code></pre></div><h3 id="2-get-fork-specific-parameters">2. Get Fork-Specific Parameters</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_transaction_gas</span>(fork, state_test):
</span></span><span style="display:flex;"><span>    gas_cost <span style="color:#f92672">=</span> fork<span style="color:#f92672">.</span>gas_costs(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>G_TRANSACTION
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create a transaction with the correct gas parameters for this fork</span>
</span></span><span style="display:flex;"><span>    tx <span style="color:#f92672">=</span> Transaction(
</span></span><span style="display:flex;"><span>        gas_limit<span style="color:#f92672">=</span>gas_cost <span style="color:#f92672">+</span> <span style="color:#ae81ff">10000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    state_test(
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">=</span>Environment(),
</span></span><span style="display:flex;"><span>        pre<span style="color:#f92672">=</span>pre,
</span></span><span style="display:flex;"><span>        tx<span style="color:#f92672">=</span>tx,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><h3 id="3-determine-valid-transaction-types">3. Determine Valid Transaction Types</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_transaction_types</span>(fork, state_test):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tx_type <span style="color:#f92672">in</span> fork<span style="color:#f92672">.</span>tx_types(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Test each transaction type supported by this fork</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...</span>
</span></span></code></pre></div><h3 id="4-determine-valid-opcodes">4. Determine Valid Opcodes</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_opcodes</span>(fork, state_test):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create bytecode using only opcodes valid for this fork</span>
</span></span><span style="display:flex;"><span>    valid_opcodes <span style="color:#f92672">=</span> fork<span style="color:#f92672">.</span>valid_opcodes()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Use these opcodes to create test bytecode</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...</span>
</span></span></code></pre></div><h3 id="5-test-fork-transitions">5. Test Fork Transitions</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_fork_transition</span>(transition_fork, blockchain_test):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The transition_fork is a special fork type that changes behavior</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># based on block number or timestamp</span>
</span></span><span style="display:flex;"><span>    fork_before <span style="color:#f92672">=</span> transition_fork<span style="color:#f92672">.</span>fork_at(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    fork_after <span style="color:#f92672">=</span> transition_fork<span style="color:#f92672">.</span>fork_at(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Test behavior before and after transition</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...</span>
</span></span></code></pre></div><h2 id="important-fork-methods">Important Fork Methods</h2>
<h3 id="header-information">Header Information</h3>
<p>These methods determine what fields are required in block headers for a given fork:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>header_base_fee_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Added in London</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>header_prev_randao_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Added in Paris</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>header_withdrawals_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Added in Shanghai</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>header_excess_blob_gas_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Added in Cancun</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>header_blob_gas_used_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Added in Cancun</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>header_beacon_root_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Added in Cancun</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>header_requests_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Added in Prague</span>
</span></span></code></pre></div><h3 id="gas-parameters">Gas Parameters</h3>
<p>Methods for determining gas costs and calculations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>gas_costs(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns a GasCosts dataclass</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>memory_expansion_gas_calculator(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns a callable</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>transaction_intrinsic_cost_calculator(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns a callable</span>
</span></span></code></pre></div><h3 id="transaction-types">Transaction Types</h3>
<p>Methods for determining valid transaction types:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>tx_types(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns list of supported transaction types</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>contract_creating_tx_types(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns list of tx types that can create contracts </span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>precompiles(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns list of precompile addresses</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>system_contracts(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns list of system contract addresses</span>
</span></span></code></pre></div><h3 id="evm-features">EVM Features</h3>
<p>Methods for determining EVM features and valid opcodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>evm_code_types(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns list of supported code types (e.g., Legacy, EOF)</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>valid_opcodes()  <span style="color:#75715e"># Returns list of valid opcodes for this fork</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>call_opcodes(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns list of call opcodes with their code types</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>create_opcodes(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns list of create opcodes with their code types</span>
</span></span></code></pre></div><h3 id="blob-related-methods-cancun">Blob-related Methods (Cancun+)</h3>
<p>Methods for blob transaction support:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>supports_blobs(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns whether blobs are supported</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>blob_gas_price_calculator(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns a callable</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>excess_blob_gas_calculator(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns a callable</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>min_base_fee_per_blob_gas(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns minimum base fee per blob gas</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>blob_gas_per_blob(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns blob gas per blob</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>target_blobs_per_block(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns target blobs per block</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>max_blobs_per_block(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns max blobs per block</span>
</span></span></code></pre></div><h3 id="meta-information">Meta Information</h3>
<p>Methods for fork identification and comparison:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>name()  <span style="color:#75715e"># Returns the name of the fork</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>transition_tool_name(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Returns name for transition tools</span>
</span></span><span style="display:flex;"><span>fork<span style="color:#f92672">.</span>is_deployed()  <span style="color:#75715e"># Returns whether the fork is deployed to mainnet</span>
</span></span></code></pre></div><h2 id="fork-transitions">Fork Transitions</h2>
<p>The framework supports creating transition forks that change behavior at specific block numbers or timestamps:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@transition_fork</span>(to_fork<span style="color:#f92672">=</span>Shanghai, at_timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">15_000</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ParisToShanghaiAtTime15k</span>(Paris):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Paris to Shanghai transition at Timestamp 15k.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>With transition forks, you can test how behavior changes across fork boundaries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Behavior changes at block 5</span>
</span></span><span style="display:flex;"><span>fork <span style="color:#f92672">=</span> BerlinToLondonAt5
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#f92672">not</span> fork<span style="color:#f92672">.</span>header_base_fee_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)  <span style="color:#75715e"># Berlin doesn&#39;t require base fee</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> fork<span style="color:#f92672">.</span>header_base_fee_required(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)      <span style="color:#75715e"># London requires base fee</span>
</span></span></code></pre></div><h2 id="adding-new-fork-methods">Adding New Fork Methods</h2>
<p>When adding new fork methods, follow these guidelines:</p>
<ol>
<li><strong>Abstract Method Definition</strong>: Add the new abstract method to <code>BaseFork</code> in <code>base_fork.py</code></li>
<li><strong>Consistent Parameter Pattern</strong>: Use <code>block_number</code> and <code>timestamp</code> parameters with default values</li>
<li><strong>Method Documentation</strong>: Add docstrings explaining the purpose and behavior</li>
<li><strong>Implementation in Subsequent Forks</strong>: Implement the method in every subsequent fork class <strong>only</strong> if the fork updates the value from previous forks.</li>
</ol>
<p>Example of adding a new method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">supports_new_feature</span>(cls, block_number: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, timestamp: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Return whether the given fork supports the new feature.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>Implementation in a fork class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">supports_new_feature</span>(cls, block_number: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, timestamp: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Return whether the given fork supports the new feature.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Frontier doesn&#39;t support this feature</span>
</span></span></code></pre></div><p>Implementation in a newer fork class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">supports_new_feature</span>(cls, block_number: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, timestamp: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Return whether the given fork supports the new feature.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>  <span style="color:#75715e"># This fork does support the feature</span>
</span></span></code></pre></div><h2 id="when-to-add-a-new-fork-method">When to Add a New Fork Method</h2>
<p>Add a new fork method when:</p>
<ol>
<li><strong>A New EIP Introduces a Feature</strong>: Add methods describing the new feature&rsquo;s behavior</li>
<li><strong>Tests Need to Behave Differently</strong>: When tests need to adapt to different fork behaviors</li>
<li><strong>Common Fork Information is Needed</strong>: When multiple tests need the same fork-specific information</li>
<li><strong>Intrinsic Fork Properties Change</strong>: When gas costs, opcodes, or other intrinsic properties change</li>
</ol>
<p>Do not add a new fork method when:</p>
<ol>
<li>The information is only needed for one specific test</li>
<li>The information is not directly related to fork behavior</li>
<li>The information can be calculated using existing methods</li>
</ol>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Use Existing Methods</strong>: Check if there&rsquo;s already a method that provides the information you need</li>
<li><strong>Name Methods Clearly</strong>: Method names should clearly describe what they return</li>
<li><strong>Document Behavior</strong>: Include clear docstrings explaining the method&rsquo;s purpose and return value</li>
<li><strong>Avoid Hard-coding</strong>: Use fork methods in tests instead of hard-coding fork-specific behavior</li>
<li><strong>Test Transitions</strong>: Ensure your method works correctly with transition forks</li>
</ol>
<h2 id="example-complete-test-using-fork-methods">Example: Complete Test Using Fork Methods</h2>
<p>Here&rsquo;s an example of a test that fully utilizes fork methods to adapt its behavior:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_transaction_with_fork_adaptability</span>(fork, state_test):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prepare pre-state</span>
</span></span><span style="display:flex;"><span>    pre <span style="color:#f92672">=</span> Alloc()
</span></span><span style="display:flex;"><span>    sender <span style="color:#f92672">=</span> pre<span style="color:#f92672">.</span>fund_eoa()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Define transaction based on fork capabilities</span>
</span></span><span style="display:flex;"><span>    tx_params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;gas_limit&#34;</span>: <span style="color:#ae81ff">1_000_000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;sender&#34;</span>: sender,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add appropriate transaction type based on fork</span>
</span></span><span style="display:flex;"><span>    tx_types <span style="color:#f92672">=</span> fork<span style="color:#f92672">.</span>tx_types(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">in</span> tx_types <span style="color:#f92672">and</span> fork<span style="color:#f92672">.</span>supports_blobs(block_number<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timestamp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># EIP-4844 blob transaction (type 3)</span>
</span></span><span style="display:flex;"><span>        tx_params[<span style="color:#e6db74">&#34;blob_versioned_hashes&#34;</span>] <span style="color:#f92672">=</span> [Hash<span style="color:#f92672">.</span>generate_zero_hashes(<span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">in</span> tx_types:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># EIP-1559 transaction (type 2)</span>
</span></span><span style="display:flex;"><span>        tx_params[<span style="color:#e6db74">&#34;max_fee_per_gas&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        tx_params[<span style="color:#e6db74">&#34;max_priority_fee_per_gas&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">in</span> tx_types:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># EIP-2930 transaction (type 1)</span>
</span></span><span style="display:flex;"><span>        tx_params[<span style="color:#e6db74">&#34;access_list&#34;</span>] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create and run the test</span>
</span></span><span style="display:flex;"><span>    tx <span style="color:#f92672">=</span> Transaction(<span style="color:#f92672">**</span>tx_params)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    state_test(
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">=</span>Environment(),
</span></span><span style="display:flex;"><span>        pre<span style="color:#f92672">=</span>pre,
</span></span><span style="display:flex;"><span>        tx<span style="color:#f92672">=</span>tx,
</span></span><span style="display:flex;"><span>        post<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>            sender: Account(nonce<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>The Fork class is a powerful abstraction that allows tests to adapt to different Ethereum forks. By using fork methods consistently, you can write tests that automatically handle fork-specific behavior, making your tests more maintainable and future-proof.</p>
<p>When adding new fork methods, keep them focused, well-documented, and implement them across all forks. This will ensure that all tests can benefit from the information and that transitions between forks are handled correctly.</p>
</div>

</main>

        <footer>
            <p class="copyright text-muted">© All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

