<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
        
        <style>

    html body {
        font-family: '', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #2196F3;
        --border-width:  0 ;
    }

</style>


<link rel="stylesheet" href="http://localhost:1313/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=">





<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" crossorigin="anonymous">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
 






<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.148.0">
        


        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        <link rel="stylesheet" href="http://localhost:1313/css/callouts.css">
    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#"></a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2></h2>
        <h5></h5>
        

    </div>

    <div align="start" class="content"><h1 id="debugging-transition-tools">Debugging Transition Tools</h1>
<p>There are two flags that can help debugging <code>t8n</code> tools or the execution-spec-tests framework:</p>
<ol>
<li><code>--evm-dump-dir</code> (Default: <repo>/logs/evm): Write debug information from <code>t8n</code> tool calls to the specified directory.</li>
<li><code>--traces</code>: Collect traces of the execution from the transition tool.</li>
<li><code>--verify-fixtures</code>: Run go-ethereum&rsquo;s <code>evm blocktest</code> command to verify the generated test fixtures.</li>
</ol>
<h2 id="evm-dump-directory">EVM Dump Directory</h2>
<p>The <code>--evm-dump-dir</code> flag tells the framework to write the inputs and outputs of every call made to the <code>t8n</code> command to the specified output directory. The aim is to help debugging or simply understand how a test is interacting with the EVM. The default location is <code>logs/evm</code> in the project root.</p>
<p>Each test case receives its own sub-directory under the <code>--evm-dump-dir</code> that contains these files which can be easily accessed from the HTML test report generated by <code>fill</code> (located by default in the root of the <code>--output</code> directory).</p>
<figure markdown>
 ![HTML Report Summary](./img/evm_dump_dir_in_html_report.png){width=auto align=center}
</figure>
<p>In particular, a script <code>t8n.sh</code> is generated for each call to the <code>t8n</code> command which can be used to reproduce the call to trigger errors or attach a debugger without the need to execute Python.</p>
<p>For example, running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>fill tests/berlin/eip2930_access_list/ --fork Berlin -m blockchain_test \
</span></span><span style="display:flex;"><span>    --evm-dump-dir=/tmp/evm-dump --traces
</span></span></code></pre></div><p>will produce the directory structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ðŸ“‚ /tmp/evm-dump
</span></span><span style="display:flex;"><span>â””â”€â”€ ðŸ“‚ berlin__eip2930_access_list__test_acl__test_access_list
</span></span><span style="display:flex;"><span>    â””â”€â”€ ðŸ“‚ fork_Berlin_blockchain_test
</span></span><span style="display:flex;"><span>        â””â”€â”€ ðŸ“‚ 0
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“„ args.py
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“‚ input
</span></span><span style="display:flex;"><span>         Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ alloc.json
</span></span><span style="display:flex;"><span>         Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ env.json
</span></span><span style="display:flex;"><span>         Â Â  â”‚Â Â  â””â”€â”€ ðŸ“„ txs.json
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“‚ output
</span></span><span style="display:flex;"><span>         Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ alloc.json
</span></span><span style="display:flex;"><span>         Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ result.json
</span></span><span style="display:flex;"><span>         Â Â  â”‚Â Â  â””â”€â”€ ðŸ“„ txs.rlp
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“„ returncode.txt
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“„ stderr.txt
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“„ stdin.txt
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“„ stdout.txt
</span></span><span style="display:flex;"><span>         Â Â  â”œâ”€â”€ ðŸ“„ t8n.sh
</span></span><span style="display:flex;"><span>            â””â”€â”€ ðŸ“„ trace-0-0x5c4f07ce52f0a276a06aabdfff16cc693b5e007c018f9a42431e68200e2da515.jsonl
</span></span></code></pre></div><p>where the directory <code>0</code> is the starting index of the different calls made to the <code>t8n</code> tool executed during the test, and since the test only contains one block, there is only one directory present.</p>
<p>Note, there may be more directories present <code>1</code>, <code>2</code>, <code>3</code>,&hellip; if the test executes more blocks.</p>
<p>Each directory contains files containing information corresponding to the call, for example, the <code>args.py</code> file contains the arguments passed to the <code>t8n</code> command and the <code>output/alloc.json</code> file contains the output of the <code>t8n</code> command&rsquo;s <code>--output-alloc</code> flag.</p>
<h3 id="the-t8nsh-script">The <code>t8n.sh</code> Script</h3>
<p>The <code>t8n.sh</code> script written to the debug directory can be used to reproduce a specific call made to the <code>t8n</code> command during the test session. For example, if a Besu <code>t8n-server</code> has been started on port <code>3001</code>, the request made by the test for first block can be reproduced as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>/tmp/besu/test_access_list_fork_Berlin/0/t8n.sh 3001
</span></span></code></pre></div><p>which writes the response the from the <code>t8n-server</code> to the console output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;alloc&#34;</span> : {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;0x000000000000000000000000000000000000aaaa&#34;</span> : {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;code&#34;</span> : <span style="color:#e6db74">&#34;0x5854505854&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;balance&#34;</span> : <span style="color:#e6db74">&#34;0x4&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;nonce&#34;</span> : <span style="color:#e6db74">&#34;0x1&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;0x2adc25665018aa1fe0e6bc666dac8fc2697ff9ba&#34;</span> : {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;balance&#34;</span> : <span style="color:#e6db74">&#34;0x1bc16d674ecb26ce&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;0xa94f5374fce5edbc8e2a8697c15331677e6ebf0b&#34;</span> : {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;balance&#34;</span> : <span style="color:#e6db74">&#34;0x2cd931&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;nonce&#34;</span> : <span style="color:#e6db74">&#34;0x1&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;body&#34;</span> : <span style="color:#e6db74">&#34;0xf8a0b89e01f89b0180078304ef0094000000000000000000000000000000000000aaaa0180f838f7940000000000000000000000000000000000000000e1a0000000000000000000000000000000000000000000000000000000000000000001a02e16eb72206c93c471b5894800495ee9c64ae2d9823bcc4d6adeb5d9d9af0dd4a03be6691e933a0816c59d059a556c27c6753e6ce76d1e357b9201865c80b28df3&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;result&#34;</span> : {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;stateRoot&#34;</span> : <span style="color:#e6db74">&#34;0x51799508f764047aee6606bc6a00863856f83ee5b91555f00c8a3cbdfbec5acb&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>t8n.sh</code> is written to the debug directory for all <a href="./transition_tool_support.md">supported t8n tools</a>.</p>
<h2 id="verifying-test-fixtures-via-evm-blocktest">Verifying Test Fixtures via <code>evm blocktest</code></h2>
<p>The <code>--verify-fixtures</code> flag can be used to run go-ethereum&rsquo;s <code>evm blocktest</code> command in order to verify the generated JSON test fixtures.</p>
<p>For example, running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>fill tests/berlin/eip2930_access_list/ --fork Berlin -m blockchain_test \
</span></span><span style="display:flex;"><span>    --evm-dump-dir==/tmp/evm-dump \
</span></span><span style="display:flex;"><span>    --evm-bin=../evmone/build/bin/evmone-t8n \
</span></span><span style="display:flex;"><span>    --verify-fixtures-bin=../go-ethereum/build/bin/evm \
</span></span><span style="display:flex;"><span>    --verify-fixtures
</span></span></code></pre></div><p>will additionally run the <code>evm blocktest</code> command on every JSON fixture file and write its output to the EVM dump directory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ðŸ“‚ /tmp/evm-dump
</span></span><span style="display:flex;"><span>â””â”€â”€ ðŸ“‚ berlin__eip2930_access_list__test_acl__test_access_list
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ ðŸ“„ fixtures.json
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ ðŸ“‚ fork_Berlin_blockchain_test
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”œâ”€â”€ ðŸ“‚ 0
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ args.py
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“‚ input
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ alloc.json
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ env.json
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ ðŸ“„ txs.json
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“‚ output
</span></span><span style="display:flex;"><span>    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ðŸ“„ alloc.json
</span></span><span style="display:flex;"><span>    â”‚   ... ... ...
</span></span><span style="display:flex;"><span>    â”‚
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ ðŸ“„ verify_fixtures_args.py
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ ðŸ“„ verify_fixtures_returncode.txt
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ ðŸ“„ verify_fixtures.sh
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ ðŸ“„ verify_fixtures_stderr.txt
</span></span><span style="display:flex;"><span>    â””â”€â”€ ðŸ“„ verify_fixtures_stdout.txt
</span></span></code></pre></div><p>where the <code>verify_fixtures.sh</code> script can be used to reproduce the <code>evm blocktest</code> command.</p>
<h3 id="further---verify-fixtures-examples">Further <code>--verify-fixtures</code> Examples</h3>
<ol>
<li>
<p>No fixture verification performed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>fill
</span></span></code></pre></div></li>
<li>
<p>Verify fixtures: Use the first <code>evm</code> binary in the <code>PATH</code> to execute both the <code>t8n</code> and <code>blocktest</code> commands (i.e., same binary used; this must be a geth binary):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>fill --verify-fixtures
</span></span></code></pre></div></li>
<li>
<p>Explicitly specify the evm binary to execute the <code>blocktest</code> command (the first evm binary in the <code>PATH</code> is used for <code>t8n</code> commands; <code>--verify-fixtures</code> is not necessary):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>fill --verify-fixtures-bin=../go-ethereum/build/bin/evm
</span></span></code></pre></div></li>
<li>
<p>Explicitly set two different <code>evm</code> binaries to execute the <code>t8n</code> and <code>blocktest</code> commands; write debug data to the specified <code>--evm-dump-dir</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>fill --evm-bin=../evmone/build/bin/evmone-t8n \
</span></span><span style="display:flex;"><span>  --verify-fixtures-bin=../go-ethereum/build/bin/evm \
</span></span><span style="display:flex;"><span>  --evm-dump-dir=/tmp/evm-dump
</span></span></code></pre></div></li>
<li>
<p>Additionally use <code>--single-fixture-per-file</code> to improve the granularity of the reporting of the <code>evm blocktest</code> command by writing the fixture generated by each parametrized test case to its own file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>fill --evm-bin=../evmone/build/bin/evmone-t8n \
</span></span><span style="display:flex;"><span>  --verify-fixtures-bin=../go-ethereum/build/bin/evm \
</span></span><span style="display:flex;"><span>  --evm-dump-dir=/tmp/evm-dump \
</span></span><span style="display:flex;"><span>  --single-fixture-per-file
</span></span></code></pre></div></li>
</ol>
<p>!!! note &ldquo;Execution scope of <code>evm blocktest</code>&rdquo;</p>
<pre><code>Note, by default, that `evm blocktest` is not executed per parametrized test case, but rather per test function. This is because each fixture JSON file contains fixtures for all the parametrized test cases for one test function. This means only one error will be reported, even if multiple fixtures fail within one fixture file.

Additionally, it is only executed after all the test cases in the module have been executed[^1] and will only report the first failing test fixture in all files, even if there are multiple failing fixture files.

This means, by default, that the feedback is not as granular as for test case execution. To improve granularity, and get feedback per parametrized test case use `--single-fixture-per-file`.
</code></pre>
</div>

</main>

        <footer>
            <p class="copyright text-muted">Â© All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

