# State Tests <!-- markdownlint-disable MD051 (MD051=link-fragments "Link fragments should be valid") -->

The State Test fixture format tests are included in the fixtures subdirectory `state_tests`.

These are produced by the `StateTest` and `StateTestOnly` test specs.

## Description

The state test fixture format is used to test the state transition function of the Ethereum Virtual Machine (EVM).

It does so by defining a transaction, a pre-execution state, and a post-execution state, and verifying that the transaction execution results in the expected post-execution state.

A single JSON fixture file is composed of a JSON object where each key-value pair is a different [`Fixture`](#fixture) test object, with the key string representing the test name.

The JSON file path plus the test name are used as the unique test identifier.

As opposed to other fixture formats, the state test fixture format could contain multiple test vectors per test object, each represented by an element in the mapping of lists of the `post` field.

However tests generated by the `execution-spec-tests` repository do **not** use this feature, as every single test object contains only a single test vector.

## Consumption

For each [`Fixture`](#fixture) test object in the JSON fixture file, perform the following steps:

1. Use [`pre`](#-pre-alloc) as the starting state allocation of the execution environment for the test.
2. Use [`env`](#-env-fixtureenvironment) to configure the current execution environment.
3. For each [`Fork`](./common_types.md#fork) key of [`post`](#-post-mappingforklist-fixtureforkpost) in the test, and for each of the elements of the list of [`FixtureForkPost`](#fixtureforkpost) values:

    1. Configure the execution fork schedule according to the current [`Fork`](./common_types.md#fork) key.
    2. Using the [`indexes`](#-indexes-fixtureforkpostindexes) values, and the [`transaction`](#-transaction-fixturetransaction) object, decode the transaction to be executed.
    3. If the serialized version of the decoded transaction does not match [`txbytes`](#-txbytes-bytes), fail the test.
    4. Attempt to apply the transaction using the current execution environment:

        1. If the transaction could not be applied to the current execution context:
            - If [`expectException`](#-expectexception-transactionexception) is empty, fail the test.
            - If [`expectException`](#-expectexception-transactionexception) is not empty, revert the state to the pre-state.
        2. If the transaction could be applied to the current execution context:
            - If [`expectException`](#-expectexception-transactionexception) is not empty, fail the test.

    5. Compare the resulting post-state root with the expected post-state root contained in the [`hash`](#-hash-hash) field of the current [`FixtureForkPost`](#fixtureforkpost), and fail the test if they do not match.
    6. Compare the resulting logs hash with the expected logs contained in the [`logs`](#-logs-hash) field of the current [`FixtureForkPost`](#fixtureforkpost), and fail the test if they do not match.

## Structures

### `Fixture`

#### - `env`: [`FixtureEnvironment`](#fixtureenvironment)

Execution environment description for the test.

#### - `pre`: [`Alloc`](./common_types.md#alloc-mappingaddressaccount)

Starting account allocation for the test.

#### - `transaction`: [`FixtureTransaction`](#fixturetransaction)

Transaction to be executed.

#### - `post`: [`Mapping`](./common_types.md#mapping)`(`[`Fork`](./common_types.md#fork)`,`[`List`](./common_types.md#list)`[` [`FixtureForkPost`](#fixtureforkpost) `])`

Mapping of lists of post for verification per fork, where each element represents a single possible outcome of the transaction execution after being applied to the `pre`.

#### - `config`: [`FixtureConfig`](#fixtureconfig)

Chain configuration object.

### `FixtureConfig`

At the moment this object can contain only the `blobSchedule` that is necessary to apply the correct cap to the maximum amount of blobs that a transaction can have. Otherwise, in forks prior to Cancun for example, it will be an empty JSON object.

#### - `blobSchedule`: [`BlobSchedule`](./common_types.md#blobschedule-mappingforkforkblobschedule)

Optional; present from Cancun on. Maps forks to their blob schedule configurations as defined by [EIP-7840](https://eips.ethereum.org/EIPS/eip-7840).

### `FixtureEnvironment`

#### - `currentCoinbase`: [`Address`](./common_types.md#address)

The address of the account that will receive the rewards for building the block.

#### - `currentGasLimit`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)

Total gas limit of the block where the transaction is executed.

#### - `currentNumber`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)

Number of the block where the transaction is executed.

#### - `currentDifficulty`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)

Difficulty of the block where the transaction is executed.

#### - `currentTimestamp`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)

Timestamp of the block where the transaction is executed.

#### - `currentBaseFee`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber) `(fork: London)`

Base fee of the block where the transaction is executed.

#### - `currentRandom`: [`Hash`](./common_types.md#hash) `(fork: Paris)`

Randao value of the block where the transaction is executed.

#### - `currentExcessBlobGas`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber) `(fork: Cancun)`

Excess blob gas of the block where the transaction is executed.

### `FixtureTransaction`

#### - `nonce`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)

Nonce of the account that sends the transaction

#### - `gasPrice`: [`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)

Gas price for the transaction (Transaction types 0 & 1)

#### - `maxPriorityFeePerGas`: [`HexNumber`](./common_types.md#hexnumber)

Max priority fee per gas to pay (Transaction types 2 & 3)

#### - `maxFeePerGas`: [`HexNumber`](./common_types.md#hexnumber)

Max base fee per gas to pay (Transaction types 2 & 3)

#### - `gasLimit`: [`List`](./common_types.md#list)`[`[`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)`]`

List of gas limits used on each indexed test combination

#### - `to`: [`Address`](./common_types.md#address)` | `[`EmptyAddress`](./common_types.md#emptyaddress)

Destination address of the transaction, or an empty string to create a contract

#### - `value`: [`List`](./common_types.md#list)`[`[`ZeroPaddedHexNumber`](./common_types.md#zeropaddedhexnumber)`]`

List of values used on each indexed test combination

#### - `data`: [`List`](./common_types.md#list)`[`[`Bytes`](./common_types.md#bytes)`]`

List of data bytes used on each indexed test combination

#### - `accessLists`: [`List`](./common_types.md#list)`[`[`List`](./common_types.md#list)`[`[`Mapping`](./common_types.md#mapping)`[`[`Address`](./common_types.md#address)`,`[`List`](./common_types.md#list)`[`[`Hash`](./common_types.md#hash)`]]]]` `(fork: Berlin)`

List of account access lists used on each indexed test combination (Transaction types 1, 2 & 3)

#### - `maxFeePerBlobGas`: [`HexNumber`](./common_types.md#hexnumber) `(fork: Cancun)`

Max fee per blob gas to pay (Transaction type 3)

#### - `blobVersionedHashes`: [`List`](./common_types.md#list)`[`[`Hash`](./common_types.md#hash)`]` `(fork: Cancun)`

List of blob versioned hashes the transaction includes (Transaction type 3)

#### - `sender`: [`Address`](./common_types.md#address)

Sender address of the transaction

#### - `secretKey`: [`Hash`](./common_types.md#hash)

Private key that must be used to sign the transaction

### `FixtureForkPost`

#### - `indexes`: [`FixtureForkPostIndexes`](#fixtureforkpostindexes)

Transaction field indexes that must be used to obtain the transaction to be executed

#### - `txbytes`: [`Bytes`](./common_types.md#bytes)

Serialized bytes version of the [`FixtureTransaction`](#fixturetransaction) that was executed to produce this post-state

#### - `hash`: [`Hash`](./common_types.md#hash)

Expected state root value that results of applying the transaction to the pre-state

#### - `logs`: [`Hash`](./common_types.md#hash)

Hash of the RLP representation of the state logs result of applying the transaction to the pre-state
(TODO: double-check this.)

#### - `expectException`: [`TransactionException`](./exceptions.md#transactionexception)

Exception that is expected to be thrown by the transaction execution (Field is missing if the transaction is expected to succeed)

#### - `state`: [`Alloc`](./common_types.md#alloc-mappingaddressaccount)

Dictionary that represents the allocation after execution of the transaction.

### `FixtureForkPostIndexes`

#### - `data`: `int`

Index of the data field in the transaction

#### - `gas`: `int`

Index of the gas limit field in the transaction

#### - `value`: `int`

Index of the value field in the transaction
