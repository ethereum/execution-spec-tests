{{/* layouts/partials/sidebar.html */}}
<nav style="background:#f5f5f5;padding:1.5rem;border-radius:8px;position:sticky;top:2rem;max-height:calc(100vh - 4rem);overflow-y:auto;">
  {{ $currentPage := . }}

  {{/* Determine the current section path */}}
  {{ $currentSection := "" }}
  {{ if .IsSection }}
    {{ $currentSection = .Section }}
    {{ if .File }}
      {{ $currentSection = path.Dir .File.Path }}
    {{ end }}
  {{ else if .File }}
    {{ $currentSection = path.Dir .File.Path }}
  {{ end }}

  {{/* Get section name for display */}}
  {{ $sectionName := path.Base $currentSection }}
  {{ if eq $sectionName "main" }}
    {{ $sectionName = "Documentation Home" }}
  {{ else }}
    {{ $sectionName = (humanize $sectionName) | title }}
  {{ end }}

  {{/* Section header */}}
  <h3 style="margin-top:0;padding-bottom:.5rem;border-bottom:2px solid #ddd;">{{ $sectionName }}</h3>

  {{/* Collect pages directly in the current section */}}
  {{ $pages := slice }}
  {{ range where .Site.RegularPages "Section" "main" }}
    {{ if .File }}
      {{ $filePath := .File.Path }}
      {{ $fileDir := path.Dir $filePath }}
      {{ if eq $fileDir $currentSection }}
        {{ $pages = $pages | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Split out main.md */}}
  {{ $mainPage  := where $pages ".File.BaseFileName" "main" | first 1 }}
  {{ $otherPages := where $pages ".File.BaseFileName" "!=" "main" }}

  <ul style="list-style:none;padding:0;margin:1rem 0;">
    {{/* main.md first */}}
    {{ range $mainPage }}
      <li style="margin:.5rem 0;">
        <a href="{{ .RelPermalink }}"
           style="display:block;padding:.75rem;border-radius:4px;text-decoration:none;transition:all .2s;
                  {{ if eq . $currentPage }}
                    background-color:#007bff;color:#fff;font-weight:bold;
                  {{ else }}
                    color:#333;background-color:#fff;border:1px solid #e0e0e0;
                  {{ end }}">
          {{ .Title | default "Overview" }}
          <span style="font-size:.8em;opacity:.7;display:block;">Entry Point</span>
        </a>
      </li>
    {{ end }}

    {{/* remaining pages */}}
    {{ range $otherPages }}
      <li style="margin:.5rem 0;">
        <a href="{{ .RelPermalink }}"
           style="display:block;padding:.75rem;border-radius:4px;text-decoration:none;transition:all .2s;
                  {{ if eq . $currentPage }}
                    background-color:#007bff;color:#fff;font-weight:bold;
                  {{ else }}
                    color:#333;background-color:#fff;border:1px solid #e0e0e0;
                  {{ end }}">
          üìÑ {{ .Title | default .File.BaseFileName }}
        </a>
      </li>
    {{ end }}
  </ul>

  {{/* Discover sub-directories */}}
  {{ $subdirs := slice }}
  {{ $seenDirs := dict }}
  {{ range where .Site.RegularPages "Section" "main" }}
    {{ if .File }}
      {{ $filePath := .File.Path }}
      {{ if hasPrefix $filePath (printf "%s/" $currentSection) }}
        {{ $relPath := strings.TrimPrefix (printf "%s/" $currentSection) $filePath }}
        {{ if in $relPath "/" }}
          {{ $subdir := index (split $relPath "/") 0 }}
          {{ if not (isset $seenDirs $subdir) }}
            {{ $seenDirs = merge $seenDirs (dict $subdir true) }}
            {{ $subdirs = $subdirs | append $subdir }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if $subdirs }}
    <hr style="margin:1.5rem 0;border:none;border-top:1px solid #ddd;">
    <h4 style="margin-top:1rem;color:#666;font-size:.9em;">Subsections</h4>
    <ul style="list-style:none;padding:0;">
      {{ range sort $subdirs }}
        <li style="margin:.5rem 0;">
          <a href="/{{ $currentSection }}/{{ . }}/"
             style="display:block;padding:.5rem;color:#666;text-decoration:none;transition:all .2s;">
            üìÅ {{ humanize . }}
          </a>
        </li>
      {{ end }}
    </ul>
  {{ end }}

  {{/* Links to other main sections */}}
  {{ if not (eq $currentSection "main") }}
    <hr style="margin:1.5rem 0;border:none;border-top:1px solid #ddd;">
    <h4 style="margin-top:1rem;color:#666;font-size:.9em;">Other Sections</h4>
    <ul style="list-style:none;padding:0;font-size:.9em;">
      {{ range .Site.Menus.main }}
        <li style="margin:.25rem 0;">
          <a href="{{ .URL }}" style="color:#666;text-decoration:none;">
            ‚Üí {{ .Name }}
          </a>
        </li>
      {{ end }}
    </ul>
  {{ end }}
</nav>
